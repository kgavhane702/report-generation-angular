<div 
  class="table-widget" 
  #tableContainer
  [class.table-widget--editing]="editing"
>
  <table class="table-widget__table">
    <colgroup>
      <col *ngFor="let f of colFractions" [style.width.%]="f * 100" />
    </colgroup>
    <tbody>
      <tr 
        *ngFor="let row of rows; let rowIndex = index; trackBy: trackByRowId"
        class="table-widget__row"
        [style.height.%]="rowFractionsView[rowIndex] * 100"
      >
        <td 
          *ngFor="let rc of getRenderableRowCells(rowIndex); trackBy: trackByRenderableCell"
          class="table-widget__cell"
          [class.table-widget__cell--selected]="isCellSelected(rowIndex, rc.colIndex)"
          [attr.data-cell]="rowIndex + '-' + rc.colIndex"
          [attr.rowspan]="rc.cell.merge?.rowSpan || null"
          [attr.colspan]="rc.cell.merge?.colSpan || null"
          [style.border-color]="rc.cell.style?.borderColor || null"
          [style.border-width.px]="rc.cell.style?.borderWidth ?? null"
          [style.border-style]="rc.cell.style?.borderStyle || null"
          (mousedown)="onCellMouseDown($event, rowIndex, rc.colIndex)"
          (mouseenter)="onCellMouseEnter($event, rowIndex, rc.colIndex)"
        >
          <ng-container
            *ngTemplateOutlet="cellRenderer; context: { cell: rc.cell, rowIndex: rowIndex, cellIndex: rc.colIndex, path: '' }"
          ></ng-container>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Column/Row resize overlay -->
  <div class="table-widget__resize-overlay" aria-hidden="true">
    <div
      *ngFor="let s of colResizeSegments"
      class="table-widget__resize-handle table-widget__resize-handle--col"
      [style.left.%]="s.leftPercent"
      [style.top.%]="s.topPercent"
      [style.height.%]="s.heightPercent"
      (pointerdown)="onColResizePointerDown($event, s.boundaryIndex)"
    ></div>
    <div
      *ngFor="let s of rowResizeSegments"
      class="table-widget__resize-handle table-widget__resize-handle--row"
      [style.top.%]="s.topPercent"
      [style.left.%]="s.leftPercent"
      [style.width.%]="s.widthPercent"
      (pointerdown)="onRowResizePointerDown($event, s.boundaryIndex)"
    ></div>
  </div>
</div>

<ng-template #cellRenderer let-cell="cell" let-rowIndex="rowIndex" let-cellIndex="cellIndex" let-path="path">
  <ng-container *ngIf="!cell.split; else splitRenderer">
    <div
      class="table-widget__cell-surface"
      [attr.data-vertical-align]="cell.style?.verticalAlign || 'top'"
      [style.text-align]="cell.style?.textAlign || 'left'"
      [style.background-color]="cell.style?.backgroundColor || 'transparent'"
    >
      <div
        class="table-widget__cell-content"
        [class.table-widget__cell-content--subcell]="path !== ''"
        [attr.data-leaf]="composeLeafId(rowIndex, cellIndex, path)"
        contenteditable="true"
        tabindex="0"
        [innerHTML]="cell.contentHtml | safeHtml"
      (focus)="onCellFocus($event, rowIndex, cellIndex, path)"
      (blur)="onCellBlur($event, rowIndex, cellIndex, path)"
      (input)="onCellInput($event, rowIndex, cellIndex, path)"
      (keydown)="onCellKeydown($event, rowIndex, cellIndex, path)"
    ></div>
    </div>
  </ng-container>

  <ng-template #splitRenderer>
    <div
      class="table-widget__split-grid"
      [style.gridTemplateColumns]="'repeat(' + cell.split!.cols + ', 1fr)'"
      [style.gridTemplateRows]="'repeat(' + cell.split!.rows + ', 1fr)'"
    >
      <div
        *ngFor="let item of getRenderableSplitCells(cell); trackBy: trackByRenderableSplitCell"
        class="table-widget__sub-cell"
        [style.gridRowStart]="item.row + 1"
        [style.gridColumnStart]="item.col + 1"
        [style.gridRowEnd]="'span ' + (item.cell.merge?.rowSpan || 1)"
        [style.gridColumnEnd]="'span ' + (item.cell.merge?.colSpan || 1)"
        [style.border-color]="item.cell.style?.borderColor || null"
        [style.border-width.px]="item.cell.style?.borderWidth ?? null"
        [style.border-style]="item.cell.style?.borderStyle || null"
        [class.table-widget__sub-cell--selected]="isLeafSelected(rowIndex, cellIndex, appendPath(path, item.index))"
      >
        <ng-container
          *ngTemplateOutlet="cellRenderer; context: { cell: item.cell, rowIndex: rowIndex, cellIndex: cellIndex, path: appendPath(path, item.index) }"
        ></ng-container>
      </div>
    </div>
  </ng-template>
</ng-template>
