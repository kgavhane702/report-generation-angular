<div 
  class="table-widget" 
  #tableContainer
  [class.table-widget--editing]="editing"
>
  <table class="table-widget__table">
    <tbody>
      <tr 
        *ngFor="let row of rows; let rowIndex = index; trackBy: trackByRowId"
        class="table-widget__row"
      >
        <td 
          *ngFor="let rc of getRenderableRowCells(rowIndex); trackBy: trackByRenderableCell"
          class="table-widget__cell"
          [class.table-widget__cell--selected]="isCellSelected(rowIndex, rc.colIndex)"
          [attr.data-cell]="rowIndex + '-' + rc.colIndex"
          [attr.rowspan]="rc.cell.merge?.rowSpan || null"
          [attr.colspan]="rc.cell.merge?.colSpan || null"
          (mousedown)="onCellMouseDown($event, rowIndex, rc.colIndex)"
          (mouseenter)="onCellMouseEnter($event, rowIndex, rc.colIndex)"
        >
          <ng-container
            *ngTemplateOutlet="cellRenderer; context: { cell: rc.cell, rowIndex: rowIndex, cellIndex: rc.colIndex, path: '' }"
          ></ng-container>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<ng-template #cellRenderer let-cell="cell" let-rowIndex="rowIndex" let-cellIndex="cellIndex" let-path="path">
  <ng-container *ngIf="!cell.split; else splitRenderer">
    <div
      class="table-widget__cell-surface"
      [attr.data-vertical-align]="cell.style?.verticalAlign || 'top'"
      [style.text-align]="cell.style?.textAlign || 'left'"
      [style.background-color]="cell.style?.backgroundColor || 'transparent'"
    >
      <div
        class="table-widget__cell-content"
        [class.table-widget__cell-content--subcell]="path !== ''"
        [attr.data-leaf]="composeLeafId(rowIndex, cellIndex, path)"
        contenteditable="true"
        tabindex="0"
        [innerHTML]="cell.contentHtml | safeHtml"
        (focus)="onCellFocus($event, rowIndex, cellIndex, path)"
        (blur)="onCellBlur($event, rowIndex, cellIndex, path)"
        (input)="onCellInput($event, rowIndex, cellIndex, path)"
        (keydown)="onCellKeydown($event, rowIndex, cellIndex, path)"
      ></div>
    </div>
  </ng-container>

  <ng-template #splitRenderer>
    <div
      class="table-widget__split-grid"
      [style.gridTemplateColumns]="'repeat(' + cell.split!.cols + ', 1fr)'"
      [style.gridTemplateRows]="'repeat(' + cell.split!.rows + ', 1fr)'"
    >
      <div
        *ngFor="let item of getRenderableSplitCells(cell); trackBy: trackByRenderableSplitCell"
        class="table-widget__sub-cell"
        [style.gridRowStart]="item.row + 1"
        [style.gridColumnStart]="item.col + 1"
        [style.gridRowEnd]="'span ' + (item.cell.merge?.rowSpan || 1)"
        [style.gridColumnEnd]="'span ' + (item.cell.merge?.colSpan || 1)"
        [class.table-widget__sub-cell--selected]="isLeafSelected(rowIndex, cellIndex, appendPath(path, item.index))"
      >
        <ng-container
          *ngTemplateOutlet="cellRenderer; context: { cell: item.cell, rowIndex: rowIndex, cellIndex: cellIndex, path: appendPath(path, item.index) }"
        ></ng-container>
      </div>
    </div>
  </ng-template>
</ng-template>
