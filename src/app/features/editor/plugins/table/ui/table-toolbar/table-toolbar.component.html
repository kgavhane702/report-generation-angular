<div class="table-toolbar">
    <div class="table-toolbar__group table-toolbar__group--table-options"
      *ngIf="hasActiveTable">
    <label class="table-toolbar__check">
      <input type="checkbox" [checked]="tableOptions.headerRow" (change)="onToggleHeaderRow($event)" />
      <span>Header Row</span>
    </label>
    <label class="table-toolbar__check">
      <input type="checkbox" [checked]="tableOptions.firstColumn" (change)="onToggleFirstColumn($event)" />
      <span>First Column</span>
    </label>
    <label class="table-toolbar__check">
      <input type="checkbox" [checked]="tableOptions.totalRow" (change)="onToggleTotalRow($event)" />
      <span>Total Row</span>
    </label>
    <label class="table-toolbar__check">
      <input type="checkbox" [checked]="tableOptions.lastColumn" (change)="onToggleLastColumn($event)" />
      <span>Last Column</span>
    </label>
  </div>

  <div class="table-toolbar__separator" *ngIf="hasActiveTable"></div>

  <div class="table-toolbar__group">
    <button
      type="button"
      class="table-toolbar__button table-toolbar__button--wide"
      [disabled]="!hasActiveTable"
      (mousedown)="onImportExcelClick($event)"
      title="Import from Excel (.xlsx)"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <path d="M14 2v6h6"></path>
        <path d="M8 13h8"></path>
        <path d="M8 17h8"></path>
      </svg>
      <span class="table-toolbar__button-label">Import</span>
    </button>

    <input
      #excelFileInput
      type="file"
      accept=".xlsx"
      style="display: none"
      (change)="onExcelFileSelected($event)"
    />

    <button
      type="button"
      class="table-toolbar__button table-toolbar__button--wide"
      (mousedown)="openSplitDialog($event)"
      title="Split cell (Rows/Columns)"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="1"></rect>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="12" y1="3" x2="12" y2="21"></line>
      </svg>
      <span class="table-toolbar__button-label">Split</span>
    </button>

    <button
      type="button"
      class="table-toolbar__button table-toolbar__button--wide"
      (mousedown)="onMergeClick($event)"
      title="Merge selected cells (rectangle)"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="6" width="18" height="12" rx="1"></rect>
        <path d="M7 12h10"></path>
        <path d="M9 10l-2 2 2 2"></path>
        <path d="M15 10l2 2-2 2"></path>
      </svg>
      <span class="table-toolbar__button-label">Merge</span>
    </button>

    <button
      type="button"
      class="table-toolbar__button table-toolbar__button--wide"
      (mousedown)="onUnmergeClick($event)"
      title="Unmerge"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="6" width="18" height="12" rx="1"></rect>
        <path d="M7 12h10"></path>
        <path d="M11 9v6"></path>
        <path d="M13 9v6"></path>
      </svg>
      <span class="table-toolbar__button-label">Unmerge</span>
    </button>
  </div>

  <div class="table-toolbar__separator"></div>

  <div class="table-toolbar__group">
    <button
      type="button"
      class="table-toolbar__button"
      [disabled]="!hasActiveCell"
      (mousedown)="onInsertRowAbove($event)"
      title="Insert row above"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 10h16"></path>
        <path d="M4 14h16"></path>
        <path d="M12 2v6"></path>
        <path d="M9 5l3-3 3 3"></path>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [disabled]="!hasActiveCell"
      (mousedown)="onInsertRowBelow($event)"
      title="Insert row below"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 10h16"></path>
        <path d="M4 14h16"></path>
        <path d="M12 22v-6"></path>
        <path d="M9 19l3 3 3-3"></path>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [disabled]="!hasActiveCell"
      (mousedown)="onInsertColLeft($event)"
      title="Insert column left"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10 4v16"></path>
        <path d="M14 4v16"></path>
        <path d="M2 12h6"></path>
        <path d="M5 9l-3 3 3 3"></path>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [disabled]="!hasActiveCell"
      (mousedown)="onInsertColRight($event)"
      title="Insert column right"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10 4v16"></path>
        <path d="M14 4v16"></path>
        <path d="M22 12h-6"></path>
        <path d="M19 9l3 3-3 3"></path>
      </svg>
    </button>

    <div class="table-toolbar__mini-separator" aria-hidden="true"></div>

    <button
      type="button"
      class="table-toolbar__button"
      [disabled]="!hasActiveCell"
      (mousedown)="onDeleteRow($event)"
      title="Delete row"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="8" width="18" height="8" rx="1"></rect>
        <line x1="8" y1="10" x2="12" y2="14"></line>
        <line x1="12" y1="10" x2="8" y2="14"></line>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [disabled]="!hasActiveCell"
      (mousedown)="onDeleteCol($event)"
      title="Delete column"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="8" y="3" width="8" height="18" rx="1"></rect>
        <line x1="10" y1="10" x2="14" y2="14"></line>
        <line x1="14" y1="10" x2="10" y2="14"></line>
      </svg>
    </button>
  </div>

  <div class="table-toolbar__separator"></div>

  <div class="table-toolbar__group">
    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.isBold"
      (mousedown)="onBoldClick($event)"
      title="Bold (Ctrl+B)"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
        <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.isItalic"
      (mousedown)="onItalicClick($event)"
      title="Italic (Ctrl+I)"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="19" y1="4" x2="10" y2="4"></line>
        <line x1="14" y1="20" x2="5" y2="20"></line>
        <line x1="15" y1="4" x2="9" y2="20"></line>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.isUnderline"
      (mousedown)="onUnderlineClick($event)"
      title="Underline (Ctrl+U)"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 4v7a6 6 0 0 0 12 0V4"></path>
        <line x1="4" y1="20" x2="20" y2="20"></line>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.isStrikethrough"
      (mousedown)="onStrikethroughClick($event)"
      title="Strikethrough"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M16 6a4 4 0 0 0-8 0c0 4 10 2 10 8a4 4 0 0 1-8 0"></path>
        <line x1="4" y1="12" x2="20" y2="12"></line>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.isSuperscript"
      (mousedown)="onSuperscriptClick($event)"
      title="Superscript"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <text x="4" y="18" font-size="14" font-weight="bold" fill="currentColor" stroke="none">X</text>
        <text x="14" y="10" font-size="9" font-weight="bold" fill="currentColor" stroke="none">2</text>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.isSubscript"
      (mousedown)="onSubscriptClick($event)"
      title="Subscript"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <text x="4" y="14" font-size="14" font-weight="bold" fill="currentColor" stroke="none">X</text>
        <text x="14" y="20" font-size="9" font-weight="bold" fill="currentColor" stroke="none">2</text>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      (mousedown)="onIncreaseIndentClick($event)"
      [disabled]="!hasActiveCell"
      title="Increase indent"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 8h12"></path>
        <path d="M3 12h18"></path>
        <path d="M3 16h12"></path>
        <path d="M17 6l4 4-4 4"></path>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      (mousedown)="onDecreaseIndentClick($event)"
      [disabled]="!hasActiveCell"
      title="Decrease indent"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 8h12"></path>
        <path d="M3 12h18"></path>
        <path d="M9 16h12"></path>
        <path d="M7 6l-4 4 4 4"></path>
      </svg>
    </button>

    <div class="table-toolbar__mini-separator" aria-hidden="true"></div>

    <div class="table-toolbar__combo-wrap" title="Bullet list style">
      <button
        #bulletStyleTrigger
        type="button"
        class="table-toolbar__button"
        (mousedown)="onBulletListClick($event)"
        [disabled]="!hasActiveCell"
        title="Bullet list"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="4" cy="6" r="1.5" fill="currentColor"></circle>
          <circle cx="4" cy="12" r="1.5" fill="currentColor"></circle>
          <circle cx="4" cy="18" r="1.5" fill="currentColor"></circle>
          <path d="M9 6h12"></path>
          <path d="M9 12h12"></path>
          <path d="M9 18h12"></path>
        </svg>
        <svg class="table-toolbar__combo-arrow" width="8" height="8" viewBox="0 0 16 16" fill="currentColor">
          <path d="M4 6l4 4 4-4z"/>
        </svg>
      </button>
      
      <app-anchored-dropdown
        [open]="bulletStyleDropdownOpen()"
        [anchor]="bulletStyleTrigger"
        (closed)="closeBulletStyleDropdown()"
      >
        <div class="table-toolbar__bullet-dropdown">
          <button
            *ngFor="let style of bulletStyles"
            type="button"
            class="table-toolbar__bullet-option"
            (mousedown)="$event.preventDefault()"
            (click)="onBulletStyleSelect(style.value)"
          >
            <span class="table-toolbar__bullet-icon">{{ style.icon }}</span>
            <span class="table-toolbar__bullet-label">{{ style.label }}</span>
          </button>
        </div>
      </app-anchored-dropdown>
    </div>

    <button
      type="button"
      class="table-toolbar__button"
      (mousedown)="onNumberedListClick($event)"
      [disabled]="!hasActiveCell"
      title="Numbered list"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <text x="2" y="8" font-size="7" fill="currentColor" stroke="none">1</text>
        <text x="2" y="14" font-size="7" fill="currentColor" stroke="none">2</text>
        <text x="2" y="20" font-size="7" fill="currentColor" stroke="none">3</text>
        <path d="M9 6h12"></path>
        <path d="M9 12h12"></path>
        <path d="M9 18h12"></path>
      </svg>
    </button>

    <div class="table-toolbar__mini-separator" aria-hidden="true"></div>

    <div class="table-toolbar__combo-wrap" title="Line height">
      <button
        #lineHeightTrigger
        type="button"
        class="table-toolbar__combo table-toolbar__combo--icon"
        [disabled]="!hasActiveCell"
        (click)="openLineHeightDropdown($event)"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 6h13"></path>
          <path d="M8 12h13"></path>
          <path d="M8 18h13"></path>
          <path d="M3 4v16"></path>
          <path d="M1 6l2-2 2 2"></path>
          <path d="M1 18l2 2 2-2"></path>
        </svg>
      </button>
      <app-anchored-dropdown
        [open]="lineHeightDropdownOpen()"
        [anchor]="lineHeightTrigger"
        (closed)="closeLineHeightDropdown()"
      >
        <div class="table-toolbar__combo-dropdown-content">
          <button
            *ngFor="let lh of lineHeights"
            type="button"
            class="table-toolbar__combo-item"
            (click)="onLineHeightPick(lh)"
          >
            {{ lh }}
          </button>
        </div>
      </app-anchored-dropdown>
    </div>
  </div>

  <div class="table-toolbar__separator"></div>

  <div class="table-toolbar__group">
    <label class="table-toolbar__field" title="Font family">
      <span class="table-toolbar__field-label">Font</span>
      <select
        class="table-toolbar__select"
        [disabled]="!hasActiveCell"
        [ngModel]="fontFamilyModel"
        (ngModelChange)="onFontFamilyChange($event)"
        (mousedown)="$event.stopPropagation()"
      >
        <option *ngFor="let f of fontFamilies" [value]="f.value">{{ f.label }}</option>
      </select>
    </label>

    <label class="table-toolbar__field" title="Font size">
      <span class="table-toolbar__field-label">Size</span>
      <div class="table-toolbar__combo-wrap">
        <input
          #fontSizeTrigger
          class="table-toolbar__combo table-toolbar__combo--small"
          [disabled]="!hasActiveCell"
          [ngModel]="formattingState.fontSizePx ?? ''"
          (ngModelChange)="onFontSizeChange($event)"
          (click)="openFontSizeDropdown($event)"
          (keydown.enter)="$event.preventDefault(); closeFontSizeDropdown()"
          type="number"
          min="6"
          max="96"
          step="1"
          placeholder="Auto"
        />
        <app-anchored-dropdown
          [open]="fontSizeDropdownOpen()"
          [anchor]="fontSizeTrigger"
          (closed)="closeFontSizeDropdown()"
        >
          <div class="table-toolbar__combo-dropdown-content">
            <button
              type="button"
              class="table-toolbar__combo-item"
              (click)="onFontSizeChange(''); closeFontSizeDropdown()"
              title="Auto"
            >
              Auto
            </button>
            <button
              *ngFor="let s of fontSizes"
              type="button"
              class="table-toolbar__combo-item"
              (click)="onFontSizePick(s)"
            >
              {{ s }}
            </button>
          </div>
        </app-anchored-dropdown>
      </div>
    </label>
  </div>

  <div class="table-toolbar__separator"></div>

  <div class="table-toolbar__group">
    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.textAlign === 'left'"
      (mousedown)="onAlignClick($event, 'left')"
      title="Align Left"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="17" y1="10" x2="3" y2="10"></line>
        <line x1="21" y1="6" x2="3" y2="6"></line>
        <line x1="21" y1="14" x2="3" y2="14"></line>
        <line x1="17" y1="18" x2="3" y2="18"></line>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.textAlign === 'center'"
      (mousedown)="onAlignClick($event, 'center')"
      title="Align Center"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="10" x2="6" y2="10"></line>
        <line x1="21" y1="6" x2="3" y2="6"></line>
        <line x1="21" y1="14" x2="3" y2="14"></line>
        <line x1="18" y1="18" x2="6" y2="18"></line>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.textAlign === 'right'"
      (mousedown)="onAlignClick($event, 'right')"
      title="Align Right"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="21" y1="10" x2="7" y2="10"></line>
        <line x1="21" y1="6" x2="3" y2="6"></line>
        <line x1="21" y1="14" x2="3" y2="14"></line>
        <line x1="21" y1="18" x2="7" y2="18"></line>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.textAlign === 'justify'"
      (mousedown)="onAlignClick($event, 'justify')"
      title="Justify"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="21" y1="6" x2="3" y2="6"></line>
        <line x1="21" y1="10" x2="3" y2="10"></line>
        <line x1="21" y1="14" x2="3" y2="14"></line>
        <line x1="21" y1="18" x2="3" y2="18"></line>
      </svg>
    </button>
  </div>

  <div class="table-toolbar__separator"></div>

  <div class="table-toolbar__group">
    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.verticalAlign === 'top'"
      (mousedown)="onVerticalAlignClick($event, 'top')"
      title="Align Top"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="3" x2="12" y2="15"></line>
        <polyline points="18 9 12 3 6 9"></polyline>
        <line x1="5" y1="21" x2="19" y2="21"></line>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.verticalAlign === 'middle'"
      (mousedown)="onVerticalAlignClick($event, 'middle')"
      title="Align Middle"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="5" y1="12" x2="19" y2="12"></line>
        <polyline points="9 8 12 5 15 8"></polyline>
        <polyline points="9 16 12 19 15 16"></polyline>
      </svg>
    </button>

    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="formattingState.verticalAlign === 'bottom'"
      (mousedown)="onVerticalAlignClick($event, 'bottom')"
      title="Align Bottom"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="21" x2="12" y2="9"></line>
        <polyline points="18 15 12 21 6 15"></polyline>
        <line x1="5" y1="3" x2="19" y2="3"></line>
      </svg>
    </button>
  </div>

  <div class="table-toolbar__separator"></div>

  <div class="table-toolbar__group">
    <!-- Text Color Picker -->
    <app-color-picker
      [currentColor]="textColor"
      [colorPalette]="textColorPalette"
      icon="format_color_text"
      [disabled]="!hasActiveCell"
      title="Text color"
      (colorSelected)="onTextColorSelected($event)"
    ></app-color-picker>

    <!-- Text Highlight Picker -->
    <app-color-picker
      [currentColor]="highlightColor"
      [colorPalette]="highlightFillPalette"
      icon="format_ink_highlighter"
      [disabled]="!hasActiveCell"
      title="Text highlight"
      (colorSelected)="onHighlightSelected($event)"
    ></app-color-picker>

    <!-- Cell Fill Picker -->
    <app-color-picker
      [currentColor]="cellFillColor"
      [colorPalette]="highlightFillPalette"
      icon="format_color_fill"
      [disabled]="!hasActiveCell"
      title="Cell fill"
      (colorSelected)="onCellFillSelected($event)"
    ></app-color-picker>

    <!-- Border (single dropdown with live preview: color + style + width) -->
    <app-border-picker
      [disabled]="!hasActiveCell"
      title="Border"
      [colorPalette]="highlightFillPalette"
      [value]="{ color: borderColor, width: borderWidth, style: borderStyle }"
      (valueChange)="onBorderValueChange($event)"
    ></app-border-picker>
  </div>

  <div class="table-toolbar__separator"></div>

  <div class="table-toolbar__group">
    <button
      type="button"
      class="table-toolbar__button"
      [class.table-toolbar__button--active]="isFormatPainterActive"
      [class.table-toolbar__button--format-painter-active]="isFormatPainterActive"
      (mousedown)="onFormatPainterClick($event)"
      title="Format painter (copy cell formatting)"
    >
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="4" y="3" width="10" height="6" rx="1"></rect>
        <path d="M9 9v3"></path>
        <path d="M6 12h6l-1 8h-4l-1-8z"></path>
      </svg>
    </button>
  </div>
</div>

<div
  *ngIf="splitDialogOpen"
  class="table-toolbar__modal-backdrop"
  (mousedown)="closeSplitDialog($event)"
>
  <div class="table-toolbar__modal" (mousedown)="$event.stopPropagation()">
    <div class="table-toolbar__modal-title">Split cell</div>

    <div class="table-toolbar__modal-row">
      <label class="table-toolbar__label">
        Rows
        <input
          class="table-toolbar__input"
          type="number"
          min="1"
          [max]="splitMax"
          [(ngModel)]="splitRows"
        />
      </label>

      <label class="table-toolbar__label">
        Columns
        <input
          class="table-toolbar__input"
          type="number"
          min="1"
          [max]="splitMax"
          [(ngModel)]="splitCols"
        />
      </label>
    </div>

    <div class="table-toolbar__modal-actions">
      <button type="button" class="table-toolbar__action" (mousedown)="closeSplitDialog($event)">
        Cancel
      </button>
      <button type="button" class="table-toolbar__action table-toolbar__action--primary" (mousedown)="confirmSplit($event)">
        OK
      </button>
    </div>
  </div>
</div>

