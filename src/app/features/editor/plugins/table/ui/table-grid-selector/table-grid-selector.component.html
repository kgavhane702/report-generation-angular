<div class="table-grid-selector">
  <button 
    type="button" 
    class="table-grid-selector__trigger"
    (click)="toggleDropdown()"
    title="Insert Table"
  >
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="3" y1="9" x2="21" y2="9"></line>
      <line x1="3" y1="15" x2="21" y2="15"></line>
      <line x1="9" y1="3" x2="9" y2="21"></line>
      <line x1="15" y1="3" x2="15" y2="21"></line>
    </svg>
    <span class="table-grid-selector__label">Table</span>
    <svg class="table-grid-selector__caret" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </button>

  <div 
    class="table-grid-selector__dropdown"
    *ngIf="isOpen()"
  >
    <div class="table-grid-selector__header">{{ selectionLabel }}</div>

    <div class="table-grid-selector__tabs" role="tablist" aria-label="Table actions">
      <button
        type="button"
        class="table-grid-selector__tab"
        [class.table-grid-selector__tab--active]="mode() === 'new'"
        (click)="setMode('new')"
      >
        New
      </button>
      <button
        type="button"
        class="table-grid-selector__tab"
        [class.table-grid-selector__tab--active]="mode() === 'import'"
        (click)="setMode('import')"
      >
        Import
      </button>
    </div>
    
    <ng-container *ngIf="mode() === 'new'; else importMode">
      <div 
        class="table-grid-selector__grid"
        (mouseleave)="onGridLeave()"
      >
        <div 
          *ngFor="let rowIndex of gridRows"
          class="table-grid-selector__row"
        >
          <div
            *ngFor="let colIndex of gridColumns"
            class="table-grid-selector__cell"
            [class.table-grid-selector__cell--selected]="isCellSelected(rowIndex, colIndex)"
            (mouseenter)="onCellHover(rowIndex, colIndex)"
            (click)="onCellClick(rowIndex, colIndex)"
          ></div>
        </div>
      </div>
    </ng-container>

    <ng-template #importMode>
      <div class="table-grid-selector__import">
        <button
          type="button"
          class="table-grid-selector__import-button"
          (click)="openImportDialog($event)"
          title="Import a new table from Excel/CSV/JSON/XML (.xlsx, .csv, .json, .xml)"
        >
          Import from Excel/CSV/JSON/XML
        </button>
      </div>
    </ng-template>
  </div>

  <div 
    class="table-grid-selector__backdrop"
    *ngIf="isOpen()"
    (click)="onBackdropClick($event)"
  ></div>
</div>

<app-modal
  [(open)]="importDialogOpen"
  size="md"
  (closed)="cancelImport()"
>
  <ng-container appModalHeader>
    <h2 class="table-grid-selector__import-title">Import Table</h2>
  </ng-container>

  <ng-container appModalBody>
    <div class="table-grid-selector__import-dialog">
      <div class="table-grid-selector__import-dialog-hint">
        Select a file to import as a table. Supported: XLSX, CSV, JSON, XML.
      </div>

      <div class="table-grid-selector__file-upload">
        <input
          #excelFileInput
          type="file"
          accept=".xlsx,.csv,.json,.xml"
          (change)="onExcelFileSelected($event)"
          class="table-grid-selector__file-input"
          id="tableImportFileInput"
        />
        <label for="tableImportFileInput" class="table-grid-selector__file-label">
          <span class="table-grid-selector__file-button">Browse Files</span>
          <span class="table-grid-selector__file-hint">XLSX, CSV, JSON, or XML</span>
        </label>
        <div *ngIf="importFileName" class="table-grid-selector__file-name">
          Selected: {{ importFileName }}
        </div>
      </div>
    </div>
  </ng-container>

  <ng-container appModalFooter>
    <button
      type="button"
      class="table-grid-selector__import-dialog-btn table-grid-selector__import-dialog-btn--secondary"
      (click)="cancelImport()"
    >
      Cancel
    </button>
    <button
      type="button"
      class="table-grid-selector__import-dialog-btn table-grid-selector__import-dialog-btn--primary"
      (click)="confirmImport()"
      [disabled]="!importFile"
    >
      Import
    </button>
  </ng-container>
</app-modal>

