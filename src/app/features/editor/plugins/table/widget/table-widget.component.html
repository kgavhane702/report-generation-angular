<div 
  class="table-widget" 
  #tableContainer
  [class.table-widget--editing]="editing"
>
  <!--
    IMPORTANT:
    The top-level table is rendered as a CSS grid (same as split grids) so the browser's native <table>
    layout cannot reflow row heights (which used to shrink other rows when one cell grows).
  -->
  <div
    class="table-widget__grid"
    [style.gridTemplateColumns]="topLevelGridTemplateColumns"
    [style.gridTemplateRows]="topLevelGridTemplateRows"
  >
    <ng-container *ngFor="let row of rows; let rowIndex = index; trackBy: trackByRowId">
      <div
        *ngFor="let rc of getRenderableRowCells(rowIndex); trackBy: trackByRenderableCell"
        class="table-widget__cell"
        [class.table-widget__cell--selected]="isCellSelected(rowIndex, rc.colIndex)"
        [attr.data-cell]="rowIndex + '-' + rc.colIndex"
        [style.gridRowStart]="rowIndex + 1"
        [style.gridColumnStart]="rc.colIndex + 1"
        [style.gridRowEnd]="'span ' + (rc.cell.merge?.rowSpan || 1)"
        [style.gridColumnEnd]="'span ' + (rc.cell.merge?.colSpan || 1)"
        [style.border-color]="rc.cell.style?.borderColor || null"
        [style.border-width.px]="rc.cell.style?.borderWidth ?? null"
        [style.border-style]="rc.cell.style?.borderStyle || null"
        (mousedown)="onCellMouseDown($event, rowIndex, rc.colIndex)"
        (mouseenter)="onCellMouseEnter($event, rowIndex, rc.colIndex)"
      >
        <ng-container
          *ngTemplateOutlet="cellRenderer; context: { cell: rc.cell, rowIndex: rowIndex, cellIndex: rc.colIndex, path: '' }"
        ></ng-container>
      </div>
    </ng-container>
  </div>

  <!-- Column/Row resize overlay -->
  <div class="table-widget__resize-overlay" aria-hidden="true">
    <div
      *ngFor="let s of colResizeSegments"
      class="table-widget__resize-handle table-widget__resize-handle--col"
      [style.left.%]="s.leftPercent"
      [style.top.%]="s.topPercent"
      [style.height.%]="s.heightPercent"
      (pointerdown)="onColResizePointerDown($event, s.boundaryIndex)"
    ></div>
    <div
      *ngFor="let s of rowResizeSegments"
      class="table-widget__resize-handle table-widget__resize-handle--row"
      [style.top.%]="s.topPercent"
      [style.left.%]="s.leftPercent"
      [style.width.%]="s.widthPercent"
      (pointerdown)="onRowResizePointerDown($event, s.boundaryIndex)"
    ></div>
  </div>
</div>

<ng-template #cellRenderer let-cell="cell" let-rowIndex="rowIndex" let-cellIndex="cellIndex" let-path="path">
  <ng-container *ngIf="!cell.split; else splitRenderer">
    <div
      class="table-widget__cell-surface"
      [attr.data-vertical-align]="cell.style?.verticalAlign || 'top'"
      [style.text-align]="cell.style?.textAlign || 'left'"
      [style.background-color]="cell.style?.backgroundColor || 'transparent'"
      [style.font-family]="cell.style?.fontFamily || null"
      [style.font-size.px]="cell.style?.fontSizePx ?? null"
    >
      <div
        class="table-widget__cell-content"
        [class.table-widget__cell-content--subcell]="path !== ''"
        [attr.data-leaf]="composeLeafId(rowIndex, cellIndex, path)"
        contenteditable="true"
        tabindex="0"
        [innerHTML]="cell.contentHtml | safeHtml"
      (focus)="onCellFocus($event, rowIndex, cellIndex, path)"
      (blur)="onCellBlur($event, rowIndex, cellIndex, path)"
      (input)="onCellInput($event, rowIndex, cellIndex, path)"
      (keydown)="onCellKeydown($event, rowIndex, cellIndex, path)"
    ></div>
    </div>
  </ng-container>

  <ng-template #splitRenderer>
    <div
      class="table-widget__split-grid"
      [style.gridTemplateColumns]="getSplitGridTemplateColumns(rowIndex, cellIndex, path, cell)"
      [style.gridTemplateRows]="getSplitGridTemplateRows(rowIndex, cellIndex, path, cell)"
    >
      <!-- Split-grid resize overlay -->
      <div class="table-widget__split-resize-overlay" aria-hidden="true">
        <div
          *ngFor="let s of getSplitColResizeSegments(rowIndex, cellIndex, path, cell)"
          class="table-widget__resize-handle table-widget__resize-handle--col"
          [style.left.%]="s.leftPercent"
          [style.top.%]="s.topPercent"
          [style.height.%]="s.heightPercent"
          (pointerdown)="onSplitColResizePointerDown($event, rowIndex, cellIndex, path, s.boundaryIndex)"
        ></div>
        <div
          *ngFor="let s of getSplitRowResizeSegments(rowIndex, cellIndex, path, cell)"
          class="table-widget__resize-handle table-widget__resize-handle--row"
          [style.top.%]="s.topPercent"
          [style.left.%]="s.leftPercent"
          [style.width.%]="s.widthPercent"
          (pointerdown)="onSplitRowResizePointerDown($event, rowIndex, cellIndex, path, s.boundaryIndex)"
        ></div>
      </div>

      <div
        *ngFor="let item of getRenderableSplitCells(cell); trackBy: trackByRenderableSplitCell"
        class="table-widget__sub-cell"
        [style.gridRowStart]="item.row + 1"
        [style.gridColumnStart]="item.col + 1"
        [style.gridRowEnd]="'span ' + (item.cell.merge?.rowSpan || 1)"
        [style.gridColumnEnd]="'span ' + (item.cell.merge?.colSpan || 1)"
        [style.border-color]="item.cell.style?.borderColor || null"
        [style.border-width.px]="item.cell.style?.borderWidth ?? null"
        [style.border-style]="item.cell.style?.borderStyle || null"
        [class.table-widget__sub-cell--selected]="isLeafSelected(rowIndex, cellIndex, appendPath(path, item.index))"
      >
        <ng-container
          *ngTemplateOutlet="cellRenderer; context: { cell: item.cell, rowIndex: rowIndex, cellIndex: cellIndex, path: appendPath(path, item.index) }"
        ></ng-container>
      </div>
    </div>
  </ng-template>
</ng-template>
