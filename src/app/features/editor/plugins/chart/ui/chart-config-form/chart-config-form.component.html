<form [formGroup]="form" class="chart-config-dialog__form" (ngSubmit)="save()">
  <app-tabs ariaLabel="Chart configuration tabs" [stickyHeader]="true" [(activeIndex)]="activeTabIndex">
    <app-tab label="Chart">
      <div class="chart-config-dialog__tab-content">
        <!-- Chart Type -->
        <div class="chart-config-dialog__section">
          <label class="chart-config-dialog__label" for="chartType">Chart Type</label>
          <select id="chartType" formControlName="chartType" class="chart-config-dialog__select">
            <option *ngFor="let type of chartTypes" [value]="type">
              {{ chartTypeLabels[type] }}
            </option>
          </select>
        </div>

        <!-- Title -->
        <div class="chart-config-dialog__section">
          <label class="chart-config-dialog__label" for="title">Chart Title</label>
          <input
            id="title"
            type="text"
            formControlName="title"
            class="chart-config-dialog__input"
            placeholder="Enter chart title"
          />
        </div>
      </div>
    </app-tab>

    <app-tab label="Data">
      <div class="chart-config-dialog__tab-content">
        <!-- Import Dataset (Backend) -->
        <div class="chart-config-dialog__section" [formGroup]="importForm">
          <label class="chart-config-dialog__label">Import Dataset</label>

          <app-tabs
            ariaLabel="Import dataset tabs"
            [stickyHeader]="false"
            [activeIndex]="importTabIndex"
            (activeIndexChange)="onImportTabChanged($event)"
          >
            <app-tab label="Browse">
              <div class="chart-config-dialog__file-upload">
                <input
                  type="file"
                  accept=".xlsx,.csv,.json,.xml"
                  (change)="onImportFileSelected($event)"
                  class="chart-config-dialog__file-input"
                  id="chartImportFileInput"
                />
                <label for="chartImportFileInput" class="chart-config-dialog__file-label">
                  <span class="chart-config-dialog__file-button">Browse Files</span>
                  <span class="chart-config-dialog__file-hint">XLSX, CSV, JSON, or XML</span>
                </label>
                <span *ngIf="selectedFileName" class="chart-config-dialog__file-name">
                  Selected: {{ selectedFileName }}
                </span>
              </div>

              <div
                class="chart-config-dialog__row"
                *ngIf="detectedImportFormat === ImportFormat.XLSX || detectedImportFormat === ImportFormat.CSV"
              >
                <div class="chart-config-dialog__section" *ngIf="detectedImportFormat === ImportFormat.XLSX">
                  <label class="chart-config-dialog__label" for="sheetIndex">Sheet Index (0-based)</label>
                  <input
                    id="sheetIndex"
                    type="number"
                    class="chart-config-dialog__input"
                    formControlName="sheetIndex"
                    min="0"
                    [disabled]="importInProgress"
                  />
                </div>
                <div class="chart-config-dialog__section" *ngIf="detectedImportFormat === ImportFormat.CSV">
                  <label class="chart-config-dialog__label" for="delimiter">Delimiter</label>
                  <input
                    id="delimiter"
                    type="text"
                    class="chart-config-dialog__input"
                    formControlName="delimiter"
                    placeholder=","
                    [disabled]="importInProgress"
                  />
                </div>
              </div>
            </app-tab>

            <app-tab label="URL">
              <div class="chart-config-dialog__url-import">
                <app-http-request-builder [(value)]="urlRequest" [disabled]="importInProgress"></app-http-request-builder>

                <div class="chart-config-dialog__row">
                  <div class="chart-config-dialog__section">
                    <label class="chart-config-dialog__label" for="urlFormatOverride">Format (optional)</label>
                    <select
                      id="urlFormatOverride"
                      class="chart-config-dialog__select"
                      [value]="urlFormatOverride || ''"
                      (change)="urlFormatOverride = ($any($event.target).value || null)"
                      [disabled]="importInProgress"
                    >
                      <option value="">Auto-detect</option>
                      <option [value]="ImportFormat.XLSX">XLSX</option>
                      <option [value]="ImportFormat.CSV">CSV</option>
                      <option [value]="ImportFormat.JSON">JSON</option>
                      <option [value]="ImportFormat.XML">XML</option>
                    </select>
                  </div>

                  <div class="chart-config-dialog__section">
                    <label class="chart-config-dialog__label" for="urlSheetIndex">Sheet Index (XLSX, optional)</label>
                    <input
                      id="urlSheetIndex"
                      type="number"
                      class="chart-config-dialog__input"
                      formControlName="sheetIndex"
                      min="0"
                      [disabled]="importInProgress"
                    />
                  </div>
                </div>

                <div class="chart-config-dialog__section">
                  <label class="chart-config-dialog__label" for="urlDelimiter">Delimiter (CSV, optional)</label>
                  <input
                    id="urlDelimiter"
                    type="text"
                    class="chart-config-dialog__input"
                    formControlName="delimiter"
                    placeholder=","
                    [disabled]="importInProgress"
                  />
                </div>

                <div class="chart-config-dialog__actions">
                  <button
                    type="button"
                    class="chart-config-dialog__button chart-config-dialog__button--primary"
                    (click)="submitUrlImport()"
                    [disabled]="importInProgress || !(urlRequest.url || '').trim()"
                  >
                    Submit URL
                  </button>
                </div>
              </div>
            </app-tab>

            <app-tab label="Data">
              <div class="chart-config-dialog__row">
                <div class="chart-config-dialog__section">
                  <label class="chart-config-dialog__label chart-config-dialog__label--inline">
                    <input type="checkbox" class="chart-config-dialog__checkbox" formControlName="hasHeader" />
                    Header row present
                  </label>
                </div>
                <div class="chart-config-dialog__section" *ngIf="importForm.value.hasHeader">
                  <label class="chart-config-dialog__label" for="headerRowIndex">Header Row Index</label>
                  <input
                    id="headerRowIndex"
                    type="number"
                    class="chart-config-dialog__input"
                    formControlName="headerRowIndex"
                    min="0"
                    [disabled]="importInProgress"
                  />
                </div>
              </div>

              <div class="chart-config-dialog__row">
                <div class="chart-config-dialog__section">
                  <label class="chart-config-dialog__label" for="categoryColumnIndex">Category Column</label>
                  <select
                    id="categoryColumnIndex"
                    class="chart-config-dialog__select"
                    formControlName="categoryColumnIndex"
                    [disabled]="!importPreview || importInProgress"
                  >
                    <option *ngFor="let col of previewColumnIndexes" [value]="col">
                      {{ previewColumnLabel(col) }}
                    </option>
                  </select>
                </div>

                <div class="chart-config-dialog__section">
                  <label class="chart-config-dialog__label" for="aggregation">Aggregation (duplicates)</label>
                  <select id="aggregation" class="chart-config-dialog__select" formControlName="aggregation" [disabled]="importInProgress">
                    <option *ngFor="let agg of aggregationOptions" [value]="agg">{{ agg }}</option>
                  </select>
                </div>
              </div>

              <div class="chart-config-dialog__section" *ngIf="importPreview">
                <label class="chart-config-dialog__label">Series Columns</label>
                <div class="chart-config-dialog__series-columns">
                  <label
                    *ngFor="let col of previewColumnIndexes"
                    class="chart-config-dialog__label chart-config-dialog__label--inline chart-config-dialog__label--small"
                  >
                    <input
                      type="checkbox"
                      class="chart-config-dialog__checkbox"
                      [checked]="isSeriesColumnSelected(col)"
                      [disabled]="importInProgress || col === importForm.value.categoryColumnIndex"
                      (change)="toggleSeriesColumn(col, $event)"
                    />
                    {{ previewColumnLabel(col) }}
                  </label>
                </div>
              </div>

              <div class="chart-config-dialog__actions">
                <button
                  type="button"
                  class="chart-config-dialog__button chart-config-dialog__button--secondary"
                  (click)="previewImport()"
                  [disabled]="
                    importInProgress ||
                    (importSourceMode === 'file' ? !selectedImportFile : !(urlRequest.url || '').trim())
                  "
                >
                  {{ importInProgress ? 'Importing…' : (importPreview ? 'Update Preview' : 'Preview Import') }}
                </button>
                <button
                  type="button"
                  class="chart-config-dialog__button chart-config-dialog__button--primary"
                  (click)="applyImportToChart()"
                  [disabled]="!importResponse?.chartData"
                >
                  Apply to Chart
                </button>
              </div>

              <div *ngIf="importError" class="chart-config-dialog__import-error">
                {{ importError }}
              </div>

              <div *ngIf="importWarnings.length" class="chart-config-dialog__import-warnings">
                <div class="chart-config-dialog__import-warnings-title">Warnings</div>
                <ul class="chart-config-dialog__import-warnings-list">
                  <li *ngFor="let w of importWarnings">{{ w.code }}: {{ w.message }}</li>
                </ul>
              </div>

              <div *ngIf="importInProgress || importPreview" class="chart-config-dialog__preview">
                <div class="chart-config-dialog__preview-meta">
                  <ng-container *ngIf="importPreview; else previewLoadingMeta">
                    Preview: {{ importPreview.totalRows }} rows × {{ importPreview.totalCols }} cols (showing first {{ importPreview.rows.length }})
                  </ng-container>
                  <ng-template #previewLoadingMeta>Loading preview…</ng-template>
                </div>

                <div class="chart-config-dialog__preview-table-wrapper">
                  <div *ngIf="importInProgress" class="chart-config-dialog__loading-overlay" aria-live="polite" aria-busy="true">
                    <div class="chart-config-dialog__loading-spinner"></div>
                  </div>

                  <table *ngIf="importPreview" class="chart-config-dialog__preview-table">
                    <tbody>
                      <tr *ngFor="let row of importPreview.rows">
                        <td *ngFor="let cell of row">{{ cell }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </app-tab>
          </app-tabs>
        </div>

        <!-- Labels -->
        <div class="chart-config-dialog__section">
          <div class="chart-config-dialog__section-header">
            <div class="chart-config-dialog__section-title">
              <label class="chart-config-dialog__label">Categories / Labels</label>
              <span class="chart-config-dialog__hint">{{ selectedLabelCount }} / {{ labelsFormArray.length }} selected</span>
            </div>

            <div class="chart-config-dialog__section-actions">
              <label class="chart-config-dialog__label chart-config-dialog__label--inline chart-config-dialog__label--small">
                <input
                  type="checkbox"
                  class="chart-config-dialog__checkbox"
                  [checked]="areAllLabelsSelected"
                  [indeterminate]="isLabelSelectionIndeterminate"
                  (change)="toggleAllLabels($event)"
                />
                Select All
              </label>
              <button
                type="button"
                class="chart-config-dialog__button chart-config-dialog__button--small"
                (click)="addLabel()"
              >
                + Add
              </button>
            </div>
          </div>
          <div formArrayName="labels" class="chart-config-dialog__list">
            <div *ngFor="let control of labelsFormArray.controls; let i = index" class="chart-config-dialog__list-item">
              <input
                type="checkbox"
                class="chart-config-dialog__checkbox"
                [formControl]="$any(labelVisibilityFormArray.at(i))"
                [attr.aria-label]="'Toggle category ' + (labelsFormArray.at(i).value || ('Label ' + (i + 1)))"
              />
              <input
                type="text"
                [formControl]="$any(control)"
                class="chart-config-dialog__input"
                [placeholder]="'Label ' + (i + 1)"
              />
            </div>
          </div>
        </div>

        <!-- Series -->
        <div class="chart-config-dialog__section">
          <div class="chart-config-dialog__section-header">
            <label class="chart-config-dialog__label">Data Series</label>
            <button
              type="button"
              class="chart-config-dialog__button chart-config-dialog__button--small"
              (click)="addSeries()"
            >
              + Add Series
            </button>
          </div>
          <div formArrayName="series" class="chart-config-dialog__series-list">
            <div
              *ngFor="let seriesGroup of seriesFormArray.controls; let i = index"
              formGroupName="{{ i }}"
              class="chart-config-dialog__series-item"
            >
              <div class="chart-config-dialog__series-header">
                <input
                  type="text"
                  formControlName="name"
                  class="chart-config-dialog__input chart-config-dialog__input--series-name"
                  placeholder="Series name"
                />
                <input
                  type="color"
                  formControlName="color"
                  class="chart-config-dialog__color-input"
                  title="Series color"
                />
                <select
                  *ngIf="shouldShowSeriesTypeSelector"
                  formControlName="seriesType"
                  class="chart-config-dialog__select chart-config-dialog__select--series-type"
                  title="Chart type for this series"
                >
                  <option value="bar">Bar</option>
                  <option value="line">Line</option>
                </select>
                <select
                  *ngIf="shouldShowLineStyle(i)"
                  formControlName="lineStyle"
                  class="chart-config-dialog__select chart-config-dialog__select--line-style"
                  title="Line style"
                >
                  <option *ngFor="let style of lineStyles" [value]="style">
                    {{ lineStyleLabels[style] }}
                  </option>
                </select>
                <button
                  type="button"
                  class="chart-config-dialog__button chart-config-dialog__button--small chart-config-dialog__button--danger"
                  (click)="removeSeries(i)"
                  [disabled]="seriesFormArray.length <= 1"
                >
                  Remove
                </button>
              </div>

              <div class="chart-config-dialog__data-points">
                <div class="chart-config-dialog__section-header">
                  <label class="chart-config-dialog__label chart-config-dialog__label--small">Data Points</label>
                  <button
                    type="button"
                    class="chart-config-dialog__button chart-config-dialog__button--small"
                    (click)="addDataPoint(i)"
                  >
                    + Add
                  </button>
                  <button
                    type="button"
                    class="chart-config-dialog__button chart-config-dialog__button--small"
                    (click)="syncDataPoints()"
                  >
                    Sync All
                  </button>
                </div>

                <div
                  *ngIf="visibleLabelIndexes.length > 0; else noLabelsSelected"
                  formArrayName="data"
                  class="chart-config-dialog__data-grid"
                >
                  <div *ngFor="let j of visibleLabelIndexes; trackBy: trackByIndex" class="chart-config-dialog__data-item">
                    <label class="chart-config-dialog__data-label">
                      {{ labelsFormArray.at(j).value || ('Point ' + (j + 1)) }}:
                    </label>
                    <input
                      type="number"
                      [formControl]="$any(getSeriesDataArray(i).at(j))"
                      class="chart-config-dialog__input chart-config-dialog__input--number"
                      step="0.01"
                    />
                  </div>
                </div>

                <ng-template #noLabelsSelected>
                  <div class="chart-config-dialog__empty">
                    No categories selected. Use the checkboxes above (or Select All) to show data points.
                  </div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </app-tab>

    <app-tab label="Axes">
      <div class="chart-config-dialog__tab-content">
        <!-- Axis Labels -->
        <div class="chart-config-dialog__row">
          <div class="chart-config-dialog__section">
            <label class="chart-config-dialog__label" for="xAxisLabel">X-Axis Label</label>
            <input
              id="xAxisLabel"
              type="text"
              formControlName="xAxisLabel"
              class="chart-config-dialog__input"
              placeholder="X-axis label"
            />
          </div>
          <div class="chart-config-dialog__section">
            <label class="chart-config-dialog__label" for="yAxisLabel">Y-Axis Label</label>
            <input
              id="yAxisLabel"
              type="text"
              formControlName="yAxisLabel"
              class="chart-config-dialog__input"
              placeholder="Y-axis label"
            />
          </div>
        </div>

        <!-- Axis Lines -->
        <div class="chart-config-dialog__section">
          <label class="chart-config-dialog__label">
            <input type="checkbox" formControlName="showAxisLines" class="chart-config-dialog__checkbox" />
            Show Axis Lines
          </label>
        </div>
      </div>
    </app-tab>

    <app-tab label="Legend & Labels">
      <div class="chart-config-dialog__tab-content">
        <!-- Legend -->
        <div class="chart-config-dialog__row">
          <div class="chart-config-dialog__section">
            <label class="chart-config-dialog__label">
              <input type="checkbox" formControlName="showLegend" class="chart-config-dialog__checkbox" />
              Show Legend
            </label>
          </div>
          <div class="chart-config-dialog__section" *ngIf="form.value.showLegend">
            <label class="chart-config-dialog__label" for="legendPosition">Legend Position</label>
            <select id="legendPosition" formControlName="legendPosition" class="chart-config-dialog__select">
              <option *ngFor="let pos of legendPositions" [value]="pos">
                {{ pos | titlecase }}
              </option>
            </select>
          </div>
        </div>

        <!-- Value Labels -->
        <div class="chart-config-dialog__row">
          <div class="chart-config-dialog__section">
            <label class="chart-config-dialog__label">
              <input type="checkbox" formControlName="showValueLabels" class="chart-config-dialog__checkbox" />
              Show Value Labels
            </label>
          </div>
          <div class="chart-config-dialog__section" *ngIf="form.value.showValueLabels">
            <label class="chart-config-dialog__label" for="valueLabelPosition">Label Position</label>
            <select id="valueLabelPosition" formControlName="valueLabelPosition" class="chart-config-dialog__select">
              <option *ngFor="let pos of valueLabelPositions" [value]="pos">
                {{ pos | titlecase }}
              </option>
            </select>
          </div>
        </div>
      </div>
    </app-tab>
  </app-tabs>
</form>



