<div class="editor-toolbar">
  <div class="editor-toolbar__group editor-toolbar__group--document-name">
    <div class="editor-toolbar__document-name">
      <ng-container *ngIf="!isEditingDocumentName; else documentNameInput">
        <span 
          class="editor-toolbar__document-name-label"
          (click)="startEditingDocumentName()"
          [title]="documentTitle() || 'Untitled Document'"
        >
          {{ documentTitle() || 'Untitled Document' }}
        </span>
        <button
          type="button"
          class="editor-toolbar__document-name-edit"
          (click)="startEditingDocumentName()"
          title="Edit document name"
        >
          <app-icon name="edit" [size]="18"></app-icon>
        </button>
      </ng-container>
      <ng-template #documentNameInput>
        <input
          type="text"
          class="editor-toolbar__document-name-input"
          [value]="documentNameValue"
          (input)="documentNameValue = $any($event.target).value"
          (blur)="saveDocumentName()"
          (keydown.enter)="saveDocumentName()"
          (keydown.escape)="cancelEditingDocumentName()"
          #documentNameInputRef
        />
      </ng-template>
    </div>

    <div class="editor-toolbar__save-indicator" aria-live="polite">
      <ng-container [ngSwitch]="displaySaveState()">
        <span
          *ngSwitchCase="'saving'"
          class="editor-toolbar__save-indicator-inner"
          title="Saving..."
          aria-label="Saving"
        >
          <app-icon name="sync" [size]="18" class="editor-toolbar__save-indicator-icon editor-toolbar__save-indicator-icon--spinning"></app-icon>
          <span class="editor-toolbar__save-indicator-text">Saving</span>
        </span>
        <span
          *ngSwitchCase="'saved'"
          class="editor-toolbar__save-indicator-inner editor-toolbar__save-indicator-inner--clickable"
          (click)="saveNow()"
          (keydown)="onSaveIndicatorKeydown($event)"
          title="All changes saved (click to save now)"
          aria-label="Save now"
          role="button"
          tabindex="0"
        >
          <app-icon name="check_circle" [size]="18" class="editor-toolbar__save-indicator-icon editor-toolbar__save-indicator-icon--saved"></app-icon>
          <span class="editor-toolbar__save-indicator-text">Saved</span>
        </span>
        <span
          *ngSwitchDefault
          class="editor-toolbar__save-indicator-inner editor-toolbar__save-indicator-inner--clickable"
          (click)="saveNow()"
          (keydown)="onSaveIndicatorKeydown($event)"
          title="All changes saved (click to save now)"
          aria-label="Save now"
          role="button"
          tabindex="0"
        >
          <app-icon name="cloud_done" [size]="18" class="editor-toolbar__save-indicator-icon editor-toolbar__save-indicator-icon--idle"></app-icon>
          <span class="editor-toolbar__save-indicator-text">Saved</span>
        </span>
      </ng-container>
    </div>
  </div>

  <div class="editor-toolbar__group editor-toolbar__group--widgets">
    <button 
      type="button" 
      class="editor-toolbar__icon-button"
      (click)="addWidget('text')"
      title="Add Text Widget"
    >
      <app-icon name="text_fields" [size]="20"></app-icon>
    </button>
    <button
      type="button"
      class="editor-toolbar__icon-button"
      (click)="addWidget('editastra')"
      title="Add Editastra Widget (temporary)"
    >
      <app-icon name="edit_note" [size]="20"></app-icon>
    </button>
    <app-chart-widget-selector (actionSelected)="onChartWidgetAction($event)"></app-chart-widget-selector>
    <button 
      type="button" 
      class="editor-toolbar__icon-button"
      (click)="openImageInsertDialog()"
      title="Add Image"
    >
      <app-icon name="image" [size]="20"></app-icon>
    </button>
    <app-table-grid-selector
      (tableInsert)="onTableInsert($event)"
      (excelImport)="onTableImportExcel($event)"
      (urlImport)="onTableImportUrl($event)"
      [importInProgress]="tableImportInProgress()"
      [importError]="tableImportError()"
    ></app-table-grid-selector>
  </div>

  <app-undo-redo-controls></app-undo-redo-controls>

  <div class="editor-toolbar__group">
    <app-zoom-controls></app-zoom-controls>
  </div>

  <div class="editor-toolbar__group editor-toolbar__group--export">
    <button
      type="button"
      class="editor-toolbar__icon-button editor-toolbar__icon-button--export"
      (click)="exportDocument()"
      title="Export document as JSON file"
      [disabled]="remoteLoadCount() > 0"
    >
      <app-icon name="download" [size]="20"></app-icon>
    </button>
    <button
      type="button"
      class="editor-toolbar__icon-button editor-toolbar__icon-button--import"
      (click)="triggerImport()"
      title="Import document from JSON file"
    >
      <app-icon name="upload" [size]="20"></app-icon>
    </button>
    <button
      type="button"
      class="editor-toolbar__icon-button"
      (click)="downloadPDF()"
      title="Download document as PDF"
      [disabled]="remoteLoadCount() > 0"
    >
      <app-icon name="picture_as_pdf" [size]="20"></app-icon>
    </button>
  </div>
</div>

<app-modal
  [open]="imageInsertDialogOpen()"
  (openChange)="imageInsertDialogOpen.set($event)"
  size="md"
  [closeOnBackdrop]="!imageInsertInProgress()"
  [closeOnEsc]="!imageInsertInProgress()"
  [showCloseButton]="!imageInsertInProgress()"
  (closed)="cancelImageInsert()"
>
  <ng-container appModalHeader>
    <h2 class="editor-toolbar__image-insert-title">Insert Image</h2>
  </ng-container>

  <ng-container appModalBody>
    <div class="editor-toolbar__image-insert-dialog">
      <div class="editor-toolbar__image-insert-hint">
        Choose an image file. The image will be added to the canvas when you click “Insert”.
      </div>

      <div *ngIf="imageInsertError()" class="editor-toolbar__image-insert-error">
        {{ imageInsertError() }}
      </div>

      <div *ngIf="imageInsertInProgress()" class="editor-toolbar__image-insert-loading" aria-live="polite" aria-busy="true">
        <span class="editor-toolbar__image-insert-spinner" aria-hidden="true"></span>
        Reading image…
      </div>

      <div class="editor-toolbar__image-insert-file-upload">
        <input
          type="file"
          accept="image/*"
          (change)="onImageInsertFileSelected($event)"
          class="editor-toolbar__image-insert-file-input"
          id="editorToolbarImageInsertInput"
        />
        <label
          for="editorToolbarImageInsertInput"
          class="editor-toolbar__image-insert-file-label"
          [class.editor-toolbar__image-insert-file-label--disabled]="imageInsertInProgress()"
        >
          <span class="editor-toolbar__image-insert-file-button">Browse Files</span>
          <span class="editor-toolbar__image-insert-file-hint">JPG, PNG, GIF, WebP, or SVG</span>
        </label>

        <div *ngIf="imageInsertFileName()" class="editor-toolbar__image-insert-file-name">
          Selected: {{ imageInsertFileName() }}
        </div>
      </div>
    </div>
  </ng-container>

  <ng-container appModalFooter>
    <button
      type="button"
      class="editor-toolbar__image-insert-btn editor-toolbar__image-insert-btn--secondary"
      (click)="cancelImageInsert()"
      [disabled]="imageInsertInProgress()"
    >
      Cancel
    </button>
    <button
      type="button"
      class="editor-toolbar__image-insert-btn editor-toolbar__image-insert-btn--primary"
      (click)="confirmImageInsert()"
      [disabled]="!imageInsertFile() || imageInsertInProgress()"
    >
      <span *ngIf="imageInsertInProgress()" class="editor-toolbar__image-insert-btn-spinner" aria-hidden="true"></span>
      {{ imageInsertInProgress() ? 'Inserting…' : 'Insert' }}
    </button>
  </ng-container>
</app-modal>


