<div
  class="page__surface"
  [class.page__surface--active]="isActive"
  [class.page__surface--insert-armed]="insertionModeArmed"
  [class.page__surface--insert-drawing]="insertionModeDrawing"
  [ngStyle]="pageSurfaceStyle"
  [style.width.px]="widthPx"
  [style.height.px]="heightPx"
  [attr.id]="surfaceId"
  (pointerdown)="onSurfacePointerDown($event)"
>
  <div class="page__theme-layer" [ngClass]="pageThemeClasses"></div>

  <!-- Drag selection overlay - captures pointer events during drag to give priority over widgets -->
  <div
    *ngIf="selectionRect()"
    class="page__drag-overlay"
    [style.width.px]="widthPx"
    [style.height.px]="heightPx"
  ></div>

  <app-guides-overlay [pageId]="pageId" [widthPx]="widthPx" [heightPx]="heightPx"></app-guides-overlay>

  <!-- Visual safe areas (non-breaking). Helps avoid placing widgets under header/footer/logo. -->
  <div
    class="page__safe-zone page__safe-zone--top"
    *ngIf="headerLeftText || headerCenterText || headerRightText || headerLeftImage || headerCenterImage || headerRightImage || headerShowPageNumber || (logoUrl && (logoPosition === 'top-left' || logoPosition === 'top-right'))"
    aria-hidden="true"
  >
    <span class="page__safe-zone-label">Header area</span>
  </div>

  <!-- Fixed Header Elements at Top -->
  <div class="page__header" *ngIf="headerLeftText || headerCenterText || headerRightText || headerLeftImage || headerCenterImage || headerRightImage || headerShowPageNumber || (logoUrl && (logoPosition === 'top-left' || logoPosition === 'top-right'))">
    <!-- Top Left -->
    <div class="page__header-left">
      <img
        *ngIf="logoUrl && logoPosition === 'top-left'"
        [src]="logoUrl"
        alt="Logo"
        class="page__logo-image page__logo-image--inline"
        [style.max-width.px]="logoMaxWidthPx"
        [style.max-height.px]="logoMaxHeightPx"
      />
      <img *ngIf="headerLeftImage" [src]="headerLeftImage" alt="Header left" class="page__header-image" />
      <span *ngIf="headerLeftText" [style.color]="headerLeftTextColor">{{ headerLeftText }}</span>
    </div>
    
    <!-- Top Center -->
    <div class="page__header-center">
      <img *ngIf="headerCenterImage" [src]="headerCenterImage" alt="Header center" class="page__header-image" />
      <span *ngIf="headerCenterText" [style.color]="headerCenterTextColor">{{ headerCenterText }}</span>
    </div>
    
    <!-- Top Right -->
    <div class="page__header-right">
      <img
        *ngIf="logoUrl && logoPosition === 'top-right'"
        [src]="logoUrl"
        alt="Logo"
        class="page__logo-image page__logo-image--inline"
        [style.max-width.px]="logoMaxWidthPx"
        [style.max-height.px]="logoMaxHeightPx"
      />
      <img *ngIf="headerRightImage" [src]="headerRightImage" alt="Header right" class="page__header-image" />
      <span *ngIf="headerRightText" [style.color]="headerRightTextColor">{{ headerRightText }}</span>
      <span *ngIf="headerShowPageNumber" [style.color]="headerRightTextColor">{{ formattedHeaderPageNumber }}</span>
    </div>
  </div>

  <!-- 
    FIXED: Using widgetIds (stable array from granular selector) 
    instead of page.widgets (changes on every widget update)
    
    Each WidgetContainerComponent now selects its own data using widgetId.
    Widget A updating does NOT cause Widget B to re-render.
  -->
  <app-widget-container
    *ngFor="let widgetId of widgetIds(); trackBy: trackByWidgetId"
    [widgetId]="widgetId"
    [pageSize]="pageSize"
    [pageId]="pageId"
    [subsectionId]="subsectionId"
    [pageWidth]="widthPx"
    [pageHeight]="heightPx"
  ></app-widget-container>

  <div
    *ngIf="selectionRect() as rect"
    class="page__selection-rect"
    [style.left.px]="rect.x"
    [style.top.px]="rect.y"
    [style.width.px]="rect.width"
    [style.height.px]="rect.height"
  ></div>

  <div
    *ngIf="insertionModeWidgetType !== 'connector' && insertionRect() as rect"
    class="page__insertion-shape-preview"
    [style.left.px]="rect.x"
    [style.top.px]="rect.y"
    [style.width.px]="rect.width"
    [style.height.px]="rect.height"
  >
    <div
      *ngIf="insertionPreviewIsCssShape"
      class="page__insertion-shape page__insertion-shape--css"
      [ngClass]="insertionPreviewCssClass"
    ></div>

    <svg
      *ngIf="insertionPreviewIsSvgShape"
      class="page__insertion-shape page__insertion-shape--svg"
      [attr.viewBox]="insertionPreviewSvgViewBox"
      preserveAspectRatio="none"
    >
      <path
        [attr.d]="insertionPreviewSvgPath"
        [attr.fill]="insertionPreviewSvgStrokeOnly ? 'none' : 'transparent'"
        [attr.stroke]="'rgb(148, 163, 184)'"
        [attr.stroke-width]="2"
        [attr.stroke-linecap]="insertionPreviewSvgStrokeOnly ? 'round' : 'butt'"
        vector-effect="non-scaling-stroke"
      ></path>
    </svg>
  </div>

  <svg
    *ngIf="insertionPreviewConnectorLine as line"
    class="page__insertion-connector-preview"
    [attr.viewBox]="'0 0 ' + widthPx + ' ' + heightPx"
    [attr.width]="widthPx"
    [attr.height]="heightPx"
    aria-hidden="true"
  >
    <path
      class="page__insertion-connector-line"
      [attr.d]="insertionPreviewConnectorPath || ''"
    ></path>
    <circle class="page__insertion-connector-point" [attr.cx]="line.x1" [attr.cy]="line.y1" r="4"></circle>
    <circle class="page__insertion-connector-point" [attr.cx]="line.x2" [attr.cy]="line.y2" r="4"></circle>
  </svg>

  <!-- Fixed Footer Elements at Bottom -->
  <div class="page__footer" *ngIf="footerLeftText || footerCenterText || footerCenterSubText || footerLeftImage || footerCenterImage || footerRightImage || showPageNumber || (logoUrl && (logoPosition === 'bottom-left' || logoPosition === 'bottom-right'))">
    <!-- Bottom Left -->
    <div class="page__footer-left">
      <img
        *ngIf="logoUrl && logoPosition === 'bottom-left'"
        [src]="logoUrl"
        alt="Logo"
        class="page__logo-image page__logo-image--inline"
        [style.max-width.px]="logoMaxWidthPx"
        [style.max-height.px]="logoMaxHeightPx"
      />
      <img *ngIf="footerLeftImage" [src]="footerLeftImage" alt="Footer left" class="page__footer-image" />
      <span *ngIf="footerLeftText" [style.color]="footerLeftTextColor">{{ footerLeftText }}</span>
    </div>
    
    <!-- Bottom Middle -->
    <div class="page__footer-center">
      <img *ngIf="footerCenterImage" [src]="footerCenterImage" alt="Footer center" class="page__footer-image" />
      <div class="page__footer-center-line" *ngIf="footerCenterText" [style.color]="footerCenterTextColor">
        {{ footerCenterText }}
      </div>
      <div class="page__footer-center-line" *ngIf="footerCenterSubText" [style.color]="footerCenterTextColor">
        {{ footerCenterSubText }}
      </div>
    </div>
    
    <!-- Bottom Right - Page Number -->
    <div class="page__footer-right">
      <img
        *ngIf="logoUrl && logoPosition === 'bottom-right'"
        [src]="logoUrl"
        alt="Logo"
        class="page__logo-image page__logo-image--inline"
        [style.max-width.px]="logoMaxWidthPx"
        [style.max-height.px]="logoMaxHeightPx"
      />
      <img *ngIf="footerRightImage" [src]="footerRightImage" alt="Footer right" class="page__footer-image" />
      <span *ngIf="showPageNumber" [style.color]="footerRightTextColor">{{ formattedPageNumber }}</span>
    </div>
  </div>

  <div
    class="page__safe-zone page__safe-zone--bottom"
    *ngIf="footerLeftText || footerCenterText || footerCenterSubText || footerLeftImage || footerCenterImage || footerRightImage || showPageNumber || (logoUrl && (logoPosition === 'bottom-left' || logoPosition === 'bottom-right'))"
    aria-hidden="true"
  >
    <span class="page__safe-zone-label">Footer area</span>
  </div>
</div>
