<!-- Only render if we have widget data -->
<ng-container *ngIf="displayWidget() as widget">
  <div
    class="widget-container"
    [class.widget-container--selected]="isSelected"
    [class.widget-container--resizing]="isResizing"
    [class.widget-container--rotating]="isRotating"
    [attr.data-widget-id]="widgetId"
    cdkDrag
    [cdkDragConstrainPosition]="constrainDragPosition"
    [cdkDragDisabled]="isEditing || isResizing || isRotating || isDocumentLocked"
    (cdkDragStarted)="onDragStarted($event)"
    (cdkDragMoved)="onDragMoved($event)"
    (cdkDragEnded)="onDragEnded($event)"
    (pointerdown)="onWidgetPointerDown()"
    [style.left.px]="frame.x"
    [style.top.px]="frame.y"
    [style.width.px]="frame.width"
    [style.height.px]="frame.height"
    [style.zIndex]="calculatedZIndex"
    [style.transform]="rotationTransform"
  >
    <!-- Border drag handles - only these areas allow dragging -->
    <div 
      class="widget-container__drag-handle widget-container__drag-handle--top" 
      cdkDragHandle
      (pointerdown)="onDragHandlePointerDown($event)"
    ></div>
    <div 
      class="widget-container__drag-handle widget-container__drag-handle--bottom" 
      cdkDragHandle
      (pointerdown)="onDragHandlePointerDown($event)"
    ></div>
    <div 
      class="widget-container__drag-handle widget-container__drag-handle--left" 
      cdkDragHandle
      (pointerdown)="onDragHandlePointerDown($event)"
    ></div>
    <div 
      class="widget-container__drag-handle widget-container__drag-handle--right" 
      cdkDragHandle
      (pointerdown)="onDragHandlePointerDown($event)"
    ></div>

    <!-- Widget content - not draggable -->
    <div class="widget-container__content">
      <ng-container [ngSwitch]="widget.type">
        <app-text-widget
          *ngSwitchCase="'text'"
          [widget]="$any(widget)"
          (editingChange)="onEditingChange($event)"
          (propsChange)="onContentChange($event)"
        ></app-text-widget>

        <app-chart-widget
          *ngSwitchCase="'chart'"
          [widget]="$any(widget)"
          [subsectionId]="subsectionId"
          [pageId]="pageId"
          (chartPropsChange)="onChartPropsChange($event)"
        ></app-chart-widget>

        <app-image-widget
          *ngSwitchCase="'image'"
          [widget]="$any(widget)"
          (propsChange)="onContentChange($event)"
        ></app-image-widget>

        <app-table-widget
          *ngSwitchCase="'table'"
          [widget]="$any(widget)"
          (editingChange)="onEditingChange($event)"
          (propsChange)="onContentChange($event)"
        ></app-table-widget>

        <app-editastra-widget
          *ngSwitchCase="'editastra'"
          [widget]="$any(widget)"
          (editingChange)="onEditingChange($event)"
          (propsChange)="onContentChange($event)"
        ></app-editastra-widget>

        <app-object-widget
          *ngSwitchCase="'object'"
          [widget]="$any(widget)"
          (propsChange)="onContentChange($event)"
        ></app-object-widget>

        <div *ngSwitchDefault class="widget-container__placeholder">
          {{ widget.type }} widget
        </div>
      </ng-container>
    </div>

    <ng-container *ngIf="isSelected && !isDocumentLocked">
      <button
        class="widget-container__resize widget-container__resize--right"
        type="button"
        [style.cursor]="getResizeCursor('right')"
        (pointerdown)="onResizePointerDown($event, 'right')"
      ></button>
      <button
        class="widget-container__resize widget-container__resize--bottom"
        type="button"
        [style.cursor]="getResizeCursor('bottom')"
        (pointerdown)="onResizePointerDown($event, 'bottom')"
      ></button>
      <button
        class="widget-container__resize widget-container__resize--corner"
        type="button"
        [style.cursor]="getResizeCursor('corner')"
        (pointerdown)="onResizePointerDown($event, 'corner')"
        title="Resize (bottom-right)"
      ></button>
      <button
        class="widget-container__resize widget-container__resize--corner-top-right"
        type="button"
        [style.cursor]="getResizeCursor('corner-top-right')"
        (pointerdown)="onResizePointerDown($event, 'corner-top-right')"
        title="Resize (top-right)"
      ></button>
      <button
        class="widget-container__resize widget-container__resize--corner-top-left"
        type="button"
        [style.cursor]="getResizeCursor('corner-top-left')"
        (pointerdown)="onResizePointerDown($event, 'corner-top-left')"
        title="Resize (top-left)"
      ></button>
      <button
        class="widget-container__resize widget-container__resize--corner-bottom-left"
        type="button"
        [style.cursor]="getResizeCursor('corner-bottom-left')"
        (pointerdown)="onResizePointerDown($event, 'corner-bottom-left')"
        title="Resize (bottom-left)"
      ></button>
      <button
        class="widget-container__resize widget-container__resize--left"
        type="button"
        [style.cursor]="getResizeCursor('left')"
        (pointerdown)="onResizePointerDown($event, 'left')"
      ></button>
      <button
        class="widget-container__resize widget-container__resize--top"
        type="button"
        [style.cursor]="getResizeCursor('top')"
        (pointerdown)="onResizePointerDown($event, 'top')"
      ></button>

      <!-- Rotation handle - only for object widgets -->
      <button
        *ngIf="widget.type === 'object'"
        class="widget-container__rotate"
        type="button"
        (pointerdown)="onRotatePointerDown($event)"
        title="Rotate shape"
        aria-label="Rotate shape"
      >
        <app-icon name="rotate" [size]="12"></app-icon>
      </button>
    </ng-container>

    <button
      *ngIf="!isDocumentLocked"
      class="widget-container__delete"
      type="button"
      (mousedown)="onDeleteClick($event)"
      (pointerdown)="onDeleteClick($event)"
      title="Delete widget"
      aria-label="Delete widget"
    >
      <app-icon name="trash" [size]="13"></app-icon>
    </button>
  </div>

  <!-- Ghost resize outline (cursor-following preview) -->
  <div
    *ngIf="ghostFrame as gf"
    class="widget-container__resize-ghost"
    aria-hidden="true"
    [style.left.px]="gf.x"
    [style.top.px]="gf.y"
    [style.width.px]="gf.width"
    [style.height.px]="gf.height"
    [style.zIndex]="calculatedZIndex + 50"
    [style.transform]="rotationTransform"
    [style.transform-origin]="'center center'"
  ></div>
</ng-container>
