<div 
  class="table-widget" 
  #tableContainer
  [class.table-widget--editing]="editing"
  [class.table-widget--active]="toolbarService.activeTableWidgetId === widget.id"
  [class.table-widget--loading]="isLoading"
  [style.--tw-auto-fit-scale]="autoFitTextScale"
  [attr.data-tw-min-height]="minTableHeightPx"
>
  <div *ngIf="isLoading" class="table-widget__loading-overlay" aria-live="polite" aria-busy="true">
    <div class="table-widget__loading-spinner"></div>
    <div class="table-widget__loading-text">{{ loadingMessage }}</div>
  </div>

  <div *ngIf="hasError" class="table-widget__error-overlay" aria-live="polite">
    <div class="table-widget__error-content">
      <app-icon name="alert-circle" [size]="24" class="table-widget__error-icon"></app-icon>
      <div class="table-widget__error-text">{{ errorMessage }}</div>
      <button
        *ngIf="canRetry"
        type="button"
        class="table-widget__refresh-button"
        (click)="onRetryLoad()"
        title="Retry loading data"
      >
        <app-icon name="refresh" [size]="16"></app-icon>
        Refresh
      </button>
    </div>
  </div>

  <!--
    IMPORTANT:
    The top-level table is rendered as a CSS grid (same as split grids) so the browser's native <table>
    layout cannot reflow row heights (which used to shrink other rows when one cell grows).
  -->
  <div
    class="table-widget__grid"
    [style.gridTemplateColumns]="topLevelGridTemplateColumns"
    [style.gridTemplateRows]="topLevelGridTemplateRows"
  >
    <ng-container *ngFor="let row of rows; let rowIndex = index; trackBy: trackByRowId">
      <div
        *ngFor="let rc of getRenderableRowCells(rowIndex); trackBy: trackByRenderableCell"
        class="table-widget__cell"
        [class.table-widget__cell--split-owner]="!!rc.cell.split"
        [class.table-widget__cell--selected]="isCellSelected(rowIndex, rc.colIndex)"
        [attr.data-cell]="rowIndex + '-' + rc.colIndex"
        [attr.data-leaf]="rc.cell.split ? null : composeLeafId(rowIndex, rc.colIndex, '')"
        [style.gridRowStart]="rowIndex + 1"
        [style.gridColumnStart]="rc.colIndex + 1"
        [style.gridRowEnd]="'span ' + (rc.cell.merge?.rowSpan || 1)"
        [style.gridColumnEnd]="'span ' + (rc.cell.merge?.colSpan || 1)"
        [style.border-color]="rc.cell.style?.borderColor || null"
        [style.border-width.px]="rc.cell.style?.borderWidth ?? null"
        [style.border-style]="rc.cell.style?.borderStyle || null"
        (mousedown)="onCellMouseDown($event, rowIndex, rc.colIndex)"
        (click)="onCellClick($event, rowIndex, rc.colIndex)"
        (mouseenter)="onCellMouseEnter($event, rowIndex, rc.colIndex)"
      >
        <ng-container
          *ngTemplateOutlet="cellRenderer; context: { cell: rc.cell, rowIndex: rowIndex, cellIndex: rc.colIndex, path: '' }"
        ></ng-container>
      </div>
    </ng-container>
  </div>

  <!-- Column/Row resize overlay -->
  <app-table-resize-overlay
    overlayKind="top"
    [colSegmentsIndex]="colResizeSegments"
    [rowSegmentsIndex]="rowResizeSegments"
    [ghostCols]="ghostTopCols"
    [ghostRows]="ghostTopRows"
    (colPointerDownIndex)="onColResizePointerDown($event.event, $event.boundaryIndex)"
    (rowPointerDownIndex)="onRowResizePointerDown($event.event, $event.boundaryIndex)"
  ></app-table-resize-overlay>

  <!-- Shared split resize overlay (continuous lines across multiple split grids) -->
  <app-table-resize-overlay
    overlayKind="shared"
    [colSegmentsAbs]="sharedSplitColResizeSegments"
    [rowSegmentsAbs]="sharedSplitRowResizeSegments"
    [ghostCols]="ghostSharedCols"
    [ghostRows]="ghostSharedRows"
    (colPointerDownAbs)="onSharedSplitColResizePointerDown($event.event, $event.boundaryAbs)"
    (rowPointerDownAbs)="onSharedSplitRowResizePointerDown($event.event, $event.boundaryAbs)"
  ></app-table-resize-overlay>
</div>

<ng-template #cellRenderer let-cell="cell" let-rowIndex="rowIndex" let-cellIndex="cellIndex" let-path="path">
  <ng-container *ngIf="!cell.split; else splitRenderer">
    <!-- Column conditional formatting is applied at render-time via helper methods. -->
    <ng-container *ngIf="getConditionalCellSurfaceStyle(rowIndex, cellIndex, path, cell) as condStyle; else noCondStyle">
      <div
        class="table-widget__cell-surface"
        [ngClass]="getConditionalCellSurfaceClass(rowIndex, cellIndex, path, cell) || null"
        [attr.title]="getConditionalTooltip(rowIndex, cellIndex, path, cell) || null"
        [style.text-align]="(cell.style?.textAlign || getSectionStyle(rowIndex, cellIndex).textAlign) || 'left'"
        [style.background-color]="cell.style?.backgroundColor || condStyle.backgroundColor || getSectionStyle(rowIndex, cellIndex).backgroundColor || 'var(--slide-table-cell-bg, transparent)'"
        [style.font-family]="cell.style?.fontFamily || null"
        [style.font-size.px]="cell.style?.fontSizePx ?? null"
        [style.font-weight]="cell.style?.fontWeight || condStyle.fontWeight || getSectionStyle(rowIndex, cellIndex).fontWeight || null"
        [style.font-style]="cell.style?.fontStyle || condStyle.fontStyle || null"
        [style.text-decoration]="cell.style?.textDecoration || condStyle.textDecoration || null"
        [style.color]="cell.style?.color || condStyle.color || getSectionStyle(rowIndex, cellIndex).color || null"
      >
        <div class="table-widget__cell-content" [attr.data-v-align]="cell.style?.verticalAlign || 'top'">
          <app-editastra-editor
            #cellEditor
            [html]="cell.contentHtml"
            [placeholder]="''"
            [disabled]="isLoading"
            variant="table"
            [dataLeaf]="composeLeafId(rowIndex, cellIndex, path)"
            [editorClass]="'table-widget__cell-editor'"
            [editorStyles]="{
              'text-decoration': cell.style?.textDecoration || condStyle.textDecoration || null,
              'color': cell.style?.color || condStyle.color || null,
              'background-color': cell.style?.textHighlightColor || null,
              'line-height': cell.style?.lineHeight || null
            }"
            (editorFocus)="onCellFocus(cellEditor.getEditableElement(), rowIndex, cellIndex, path)"
            (editorBlur)="onCellBlur(cellEditor.getEditableElement(), rowIndex, cellIndex, path)"
            (htmlInput)="onCellInput(cellEditor.getEditableElement(), rowIndex, cellIndex, path)"
            (editorKeydown)="onCellKeydown($event, rowIndex, cellIndex, path)"
          ></app-editastra-editor>
        </div>
      </div>
    </ng-container>
    <ng-template #noCondStyle>
      <div
        class="table-widget__cell-surface"
        [ngClass]="getConditionalCellSurfaceClass(rowIndex, cellIndex, path, cell) || null"
        [attr.title]="getConditionalTooltip(rowIndex, cellIndex, path, cell) || null"
        [style.text-align]="(cell.style?.textAlign || getSectionStyle(rowIndex, cellIndex).textAlign) || 'left'"
        [style.background-color]="cell.style?.backgroundColor || getSectionStyle(rowIndex, cellIndex).backgroundColor || 'var(--slide-table-cell-bg, transparent)'"
        [style.font-family]="cell.style?.fontFamily || null"
        [style.font-size.px]="cell.style?.fontSizePx ?? null"
        [style.font-weight]="cell.style?.fontWeight || getSectionStyle(rowIndex, cellIndex).fontWeight || null"
        [style.font-style]="cell.style?.fontStyle || null"
        [style.text-decoration]="cell.style?.textDecoration || null"
        [style.color]="cell.style?.color || getSectionStyle(rowIndex, cellIndex).color || null"
      >
        <div class="table-widget__cell-content" [attr.data-v-align]="cell.style?.verticalAlign || 'top'">
          <app-editastra-editor
            #cellEditor
            [html]="cell.contentHtml"
            [placeholder]="''"
            [disabled]="isLoading"
            variant="table"
            [dataLeaf]="composeLeafId(rowIndex, cellIndex, path)"
            [editorClass]="'table-widget__cell-editor'"
            [editorStyles]="{
              'text-decoration': cell.style?.textDecoration || null,
              'color': cell.style?.color || null,
              'background-color': cell.style?.textHighlightColor || null,
              'line-height': cell.style?.lineHeight || null
            }"
            (editorFocus)="onCellFocus(cellEditor.getEditableElement(), rowIndex, cellIndex, path)"
            (editorBlur)="onCellBlur(cellEditor.getEditableElement(), rowIndex, cellIndex, path)"
            (htmlInput)="onCellInput(cellEditor.getEditableElement(), rowIndex, cellIndex, path)"
            (editorKeydown)="onCellKeydown($event, rowIndex, cellIndex, path)"
          ></app-editastra-editor>
        </div>
      </div>
    </ng-template>
  </ng-container>

  <ng-template #splitRenderer>
    <div
      class="table-widget__split-grid"
      [attr.data-owner-leaf]="composeLeafId(rowIndex, cellIndex, path)"
      [style.gridTemplateColumns]="getSplitGridTemplateColumns(rowIndex, cellIndex, path, cell)"
      [style.gridTemplateRows]="getSplitGridTemplateRows(rowIndex, cellIndex, path, cell)"
    >
      <!-- Split-grid resize overlay -->
      <app-table-resize-overlay
        overlayKind="split"
        [colSegmentsIndex]="getSplitColResizeSegments(rowIndex, cellIndex, path, cell)"
        [rowSegmentsIndex]="getSplitRowResizeSegments(rowIndex, cellIndex, path, cell)"
        [ghostCols]="getSplitGhostCols(rowIndex, cellIndex, path)"
        [ghostRows]="getSplitGhostRows(rowIndex, cellIndex, path)"
        (colPointerDownIndex)="onSplitColResizePointerDown($event.event, rowIndex, cellIndex, path, $event.boundaryIndex)"
        (rowPointerDownIndex)="onSplitRowResizePointerDown($event.event, rowIndex, cellIndex, path, $event.boundaryIndex)"
      ></app-table-resize-overlay>

      <div
        *ngFor="let item of getRenderableSplitCells(cell); trackBy: trackByRenderableSplitCell"
        class="table-widget__cell table-widget__cell--split-leaf"
        [attr.data-leaf]="composeLeafId(rowIndex, cellIndex, appendPath(path, item.index))"
        [style.gridRowStart]="item.row + 1"
        [style.gridColumnStart]="item.col + 1"
        [style.gridRowEnd]="'span ' + (item.cell.merge?.rowSpan || 1)"
        [style.gridColumnEnd]="'span ' + (item.cell.merge?.colSpan || 1)"
        [style.border-color]="item.cell.style?.borderColor || null"
        [style.border-width.px]="item.cell.style?.borderWidth ?? null"
        [style.border-style]="item.cell.style?.borderStyle || null"
        [class.table-widget__cell--selected]="isLeafSelected(rowIndex, cellIndex, appendPath(path, item.index))"
      >
        <ng-container
          *ngTemplateOutlet="cellRenderer; context: { cell: item.cell, rowIndex: rowIndex, cellIndex: cellIndex, path: appendPath(path, item.index) }"
        ></ng-container>
      </div>
    </div>
  </ng-template>
</ng-template>
