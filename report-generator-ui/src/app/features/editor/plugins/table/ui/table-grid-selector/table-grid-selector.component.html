<div class="table-grid-selector">
  <button 
    type="button" 
    class="table-grid-selector__trigger"
    (click)="toggleDropdown()"
    title="Insert Table"
  >
    <app-icon name="table"></app-icon>
    <span class="table-grid-selector__label">Table</span>
    <app-icon class="table-grid-selector__caret" name="caret_down_small"></app-icon>
  </button>

  <div 
    class="table-grid-selector__dropdown"
    *ngIf="isOpen()"
  >
    <div class="table-grid-selector__header">{{ selectionLabel }}</div>

    <div class="table-grid-selector__tabs" role="tablist" aria-label="Table actions">
      <button
        type="button"
        class="table-grid-selector__tab"
        [class.table-grid-selector__tab--active]="mode() === 'new'"
        (click)="setMode('new')"
      >
        New
      </button>
      <button
        type="button"
        class="table-grid-selector__tab"
        [class.table-grid-selector__tab--active]="mode() === 'import'"
        (click)="setMode('import')"
      >
        Import
      </button>
    </div>
    
    <ng-container *ngIf="mode() === 'new'; else importMode">
      <div 
        class="table-grid-selector__grid"
        (mouseleave)="onGridLeave()"
      >
        <div 
          *ngFor="let rowIndex of gridRows; trackBy: trackByIndex"
          class="table-grid-selector__row"
        >
          <div
            *ngFor="let colIndex of gridColumns; trackBy: trackByIndex"
            class="table-grid-selector__cell"
            [class.table-grid-selector__cell--selected]="isCellSelected(rowIndex, colIndex)"
            (mouseenter)="onCellHover(rowIndex, colIndex)"
            (click)="onCellClick(rowIndex, colIndex)"
          ></div>
        </div>
      </div>
    </ng-container>

    <ng-template #importMode>
      <div class="table-grid-selector__import">
        <button
          type="button"
          class="table-grid-selector__import-button"
          (click)="openImportDialog($event)"
          title="Import a new table from Excel/CSV/JSON/XML (.xlsx, .csv, .json, .xml)"
        >
          Import from Excel/CSV/JSON/XML
        </button>
      </div>
    </ng-template>
  </div>

  <div 
    class="table-grid-selector__backdrop"
    *ngIf="isOpen()"
    (click)="onBackdropClick($event)"
  ></div>
</div>

<app-modal
  [(open)]="importDialogOpen"
  size="md"
  [closeOnBackdrop]="!importInProgress"
  [closeOnEsc]="!importInProgress"
  [showCloseButton]="!importInProgress"
  (closed)="cancelImport()"
>
  <ng-container appModalHeader>
    <h2 class="table-grid-selector__import-title">Import Table</h2>
  </ng-container>

  <ng-container appModalBody>
    <div class="table-grid-selector__import-dialog">
      <div class="table-grid-selector__import-dialog-hint">
        Import a table from a file or from an HTTP request (URL/path).
      </div>

      <div class="table-grid-selector__import-mode">
        <button
          type="button"
          class="table-grid-selector__import-mode-btn"
          [class.table-grid-selector__import-mode-btn--active]="importDialogMode === 'file'"
          (click)="setImportDialogMode('file')"
          [disabled]="importInProgress"
        >
          File
        </button>
        <button
          type="button"
          class="table-grid-selector__import-mode-btn"
          [class.table-grid-selector__import-mode-btn--active]="importDialogMode === 'url'"
          (click)="setImportDialogMode('url')"
          [disabled]="importInProgress"
        >
          URL
        </button>
      </div>

      <div *ngIf="visibleImportError" class="table-grid-selector__import-error">
        {{ visibleImportError }}
      </div>

      <div *ngIf="importInProgress" class="table-grid-selector__import-loading" aria-live="polite" aria-busy="true">
        <div class="table-grid-selector__loading-spinner"></div>
        Importing table…
      </div>

      <ng-container *ngIf="importDialogMode === 'file'; else urlImport">
        <div class="table-grid-selector__file-upload">
          <input
            #excelFileInput
            type="file"
            accept=".xlsx,.csv,.json,.xml"
            (change)="onExcelFileSelected($event)"
            class="table-grid-selector__file-input"
            id="tableImportFileInput"
          />
          <label
            for="tableImportFileInput"
            class="table-grid-selector__file-label"
            [class.table-grid-selector__file-label--disabled]="importInProgress"
          >
            <span class="table-grid-selector__file-button">Browse Files</span>
            <span class="table-grid-selector__file-hint">XLSX, CSV, JSON, or XML</span>
          </label>
          <div *ngIf="importFileName" class="table-grid-selector__file-name">
            Selected: {{ importFileName }}
          </div>
        </div>
      </ng-container>

      <ng-template #urlImport>
        <div class="table-grid-selector__url-import">
          <app-http-request-builder [(value)]="urlRequest" [disabled]="importInProgress"></app-http-request-builder>

          <div class="table-grid-selector__url-options">
            <div class="table-grid-selector__url-option">
              <label class="table-grid-selector__url-label">Format</label>
              <select
                class="table-grid-selector__url-select"
                [value]="urlFormat || ''"
                (change)="urlFormat = ($any($event.target).value || null)"
                [disabled]="importInProgress"
              >
                <option value="">Auto-detect</option>
                <option [value]="ImportFormat.XLSX">XLSX</option>
                <option [value]="ImportFormat.CSV">CSV</option>
                <option [value]="ImportFormat.JSON">JSON</option>
                <option [value]="ImportFormat.XML">XML</option>
              </select>
            </div>

            <div class="table-grid-selector__url-option">
              <label class="table-grid-selector__url-label">Sheet index (XLSX)</label>
              <input
                class="table-grid-selector__url-input"
                type="number"
                [value]="urlSheetIndex ?? ''"
                (input)="urlSheetIndex = ($any($event.target).value === '' ? null : +$any($event.target).value)"
                [disabled]="importInProgress"
                min="0"
              />
            </div>

            <div class="table-grid-selector__url-option">
              <label class="table-grid-selector__url-label">Delimiter (CSV)</label>
              <input
                class="table-grid-selector__url-input"
                type="text"
                [value]="urlDelimiter"
                (input)="urlDelimiter = $any($event.target).value"
                [disabled]="importInProgress"
                placeholder=","
              />
            </div>
          </div>
        </div>
      </ng-template>
    </div>
  </ng-container>

  <ng-container appModalFooter>
    <button
      type="button"
      class="table-grid-selector__import-dialog-btn table-grid-selector__import-dialog-btn--secondary"
      (click)="cancelImport()"
      [disabled]="importInProgress"
    >
      Cancel
    </button>
    <button
      type="button"
      class="table-grid-selector__import-dialog-btn table-grid-selector__import-dialog-btn--primary"
      (click)="importDialogMode === 'file' ? confirmImport() : confirmUrlImport()"
      [disabled]="importDialogMode === 'file' ? (!importFile || importInProgress) : (!canImportUrl)"
    >
      <span *ngIf="importInProgress" class="table-grid-selector__btn-spinner" aria-hidden="true"></span>
      {{ importInProgress ? 'Importing…' : 'Import' }}
    </button>
  </ng-container>
</app-modal>

